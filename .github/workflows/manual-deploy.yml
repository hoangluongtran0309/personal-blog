name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - production
          - staging
      skip_tests:
        description: 'Skip tests'
        required: false
        type: boolean
        default: false

env:
  DOCKER_IMAGE: hoangluongtran0309/my-personal-blog
  JAVA_VERSION: '17'
  NODE_VERSION: '22.22.0'

jobs:
  manual-deploy:
    name: Manual Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies & build frontend
        run: |
          npm ci
          npm run build

      - name: Run tests
        if: ${{ !inputs.skip_tests }}
        run: mvn test

      - name: Build JAR
        run: mvn clean package -DskipTests

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:latest .
          docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          docker push ${{ env.DOCKER_IMAGE }}:latest
          docker push ${{ env.DOCKER_IMAGE }}:${{ github.sha }}

      - name: Test Docker container
        run: |
          docker run -d -e PORT=10000 -p 10000:10000 --name test-app ${{ env.DOCKER_IMAGE }}:latest
          sleep 15
          curl -f http://localhost:10000 || exit 1
          docker stop test-app
          docker rm test-app

      - name: Deploy to Render
        run: |
          echo "ðŸš€ Deploying to ${{ inputs.environment }}..."
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }}

      - name: Deployment summary
        run: |
          echo "## Deployment Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: ${{ env.DOCKER_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ inputs.skip_tests && 'Skipped â­ï¸' || 'Passed âœ…' }}" >> $GITHUB_STEP_SUMMARY
